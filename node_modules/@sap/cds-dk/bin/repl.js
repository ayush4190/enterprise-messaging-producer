module.exports = Object.assign (repl, { options: [], help: `
# SYNOPSIS

    *cds r | repl*

    Launches into a read-eval-print-loop, an interactive playground to
    experiment with cds' JavaScript APIs. See documentation of Node.js'
    REPL for details at _http://nodejs.org/api/repl.html_

# SEE ALSO

    *cds eval*  to evaluate and execute JavaScript
`})

function repl (_, options={}) {

  // enable `await` statement for Node.js < 16
  if (!process.env['CDS_REPL_SPAWNED'] && process.version.split('.')[0].slice(1) < '16') {
    process.env['CDS_REPL_SPAWNED'] = true
    return require('child_process').spawn('node',['--experimental-repl-await',
      ...process.argv.slice(1) ], {stdio:'inherit'}
    )
  }

  const cds = require('@sap/cds/lib')
  const path = require('path')
  const {inspect} = require('util')

  const colors = options.colors !== false
  const log = options.log || console.log
  const info = colors ? require('../lib/util/term').info : s => s
  log(info('Welcome to cds repl v'+ cds.version))

  const cdsr = require('repl').start ({...options, writer:_writer, ignoreUndefined:true })
  Object.defineProperty (cds,'repl',{value:cdsr})

  cds.lazify (Object.assign (cdsr.context,{ cds,
    Foo: lazy => new cds.entity ({name:'Foo'}),
    Bar: lazy => new cds.entity ({name:'Bar'}),
  }))

  // cosmetics: don't show cds.env when inspecting cds
  if (Reflect.getOwnPropertyDescriptor(cds,'env')) {
    Reflect.defineProperty (cds,'env',{ value:cds.env, enumerable:false })
  }

  inspect.defaultOptions.depth = 11
  function _writer (o) {
    if (!o || typeof o !== 'object') return o
    return inspect(o).replace(/\[Object: null prototype\] /g, '')
  }

  const home = process.env.HOME || process.env.USERPROFILE
  const history = path.join(home,'.cds-repl-history')
  if (cdsr.setupHistory) {  // since Node.js 11
    cdsr.setupHistory (history,()=>{})
  } else {
    const fs = require('fs')
    const historySize = 111
    fs.readFile(history, 'utf-8', (e, txt) => e || (cdsr.history = txt.split('\n')))
    cdsr.on('exit', () => {
      if (cdsr.history)  fs.writeFile(history, cdsr.history.slice(-historySize).join('\n'), () => {})
    })
  }


  process.on('uncaughtException', console.error)
  process.on('unhandledRejection', console.error)

}
/* eslint no-console:0 */
if (!module.parent) repl()
