exports.deploy = function deploy_to_sqlite (_model, _db, options) {
    const cds = require('@sap/cds/lib')
    const {to:_dbrl} = options
    const conf = cds.env.requires.db || {}
    const fts = cds.env.features.folders
    const model = _model || conf.model || cds.resolve(!fts ? '*' : ['*',fts], false)
    const file = _database4 (_db, _dbrl, conf)
    const dialect = _dbrl && _dbrl.match(/^(\w+)/) && RegExp.$1
    if (dialect) options.dialect = dialect === 'sql' ? 'plain' : dialect
    return cds.deploy(model) .to ('sqlite:'+file, options)
    .then (db => db && db.disconnect()) // REVISIT: we should NOT require to disconnect explicitly
}

function _database4 (_db,_dbrl,conf) {
    if (_db)  return _db
    if (_dbrl === 'sqlite')  return 'sqlite.db'
    if (_dbrl === 'sql')  return ':memory:'
    if (conf.credentials) return conf.credentials.database || conf.credentials.url
}
